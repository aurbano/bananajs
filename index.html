<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google Search API Sample</title>
    <script src="https://www.google.com/jsapi"></script>
    <script src="colorthief.js"></script>
    <script type="text/javascript">

      var Colors = function(options){
        "use strict";

        var Colors = this;
        Colors.thief = new ColorThief();

        if(typeof(options.googleApi) === "undefined"){
          throw {
            message: "Error: NamedColors: The Google API was not passed, please pass {googleApi: google}"
          };
        }

        options.googleApi.load("search", "1");

        function getImageColor(url){
          return new Promise(function(resolve, reject){
            var img = new Image();
            img.crossOrigin = '';
            img.onload = function(){
              try{
                console.log("Resolving ",url);
                var color = Colors.thief.getColor(img);
                console.log(color);
                resolve(color);
              }catch(e){
                console.log("failed");
                resolve(null);
              }
            };
            img.onerror = function(){
              resolve(null);
            };
            img.src = url;
          });
        }

        function getImages(colorName, resolve, reject){
          // Create an Image Search instance.
          var imageSearch = new options.googleApi.search.ImageSearch();

          // Set searchComplete as the callback function when a search is 
          // complete.  The imageSearch object will have results in it.
          imageSearch.setSearchCompleteCallback(this, function(){
            var images = imageSearch.results;
            if(images.length < 1){
              console.log("No results");
              reject({message: "No results"});
            }

            var promises = [];

            images.forEach(function(image){
              console.log("starting with ", image.url);
              promises.push(getImageColor(image.url));
            });

            Promise.all(promises).then(function(data){
              console.log("finished!");
              console.log(data);
              var r=0, g=0, b=0, count=0;
              data.forEach(function(color){
                if(color !== null){
                  count++;
                  r += color[0];
                  g += color[1];
                  b += color[2];
                }
              });
              console.log(r,g,b,count);
              r /= count;
              g /= count;
              b /= count;

              resolve([r,g,b]);
            });    
          }, null);

          // Find me a beautiful car.
          imageSearch.execute(colorName);
        }

        // Expose API
        Colors.getColor = function(colorName){
          return new Promise(
            // The resolver function is called with the ability to resolve or
            // reject the promise
            function(resolve, reject) {
                getImages(colorName, resolve, reject);
            }
          );
        };
      };

      var color = new Colors({
        googleApi: google
      });

      google.setOnLoadCallback(function(){
        var colorPromise = color.getColor("papaya whim");
        colorPromise.then(function(color){
          console.log("Returned: ", color);
          document.body.style.background = "rgb("+color[0]+","+color[1]+","+color[2],")";
        });
      });

      /*var imageSearch;

      function searchComplete() {

        // Check that we got results
        if (imageSearch.results && imageSearch.results.length > 0) {

          // Grab our content div, clear it.
          var contentDiv = document.getElementById('content');
          contentDiv.innerHTML = '';

          // Loop through our results, printing them to the page.
          var results = imageSearch.results;
          for (var i = 0; i < results.length; i++) {
            // For each result write it's title and image to the screen
            var result = results[i];
            var imgContainer = document.createElement('div');
            var title = document.createElement('div');
            
            // We use titleNoFormatting so that no HTML tags are left in the 
            // title
            title.innerHTML = result.titleNoFormatting;
            var newImg = document.createElement('img');

            // There is also a result.url property which has the escaped version
            newImg.src=result.tbUrl;
            imgContainer.appendChild(title);
            imgContainer.appendChild(newImg);

            // Put our title + image in the content
            contentDiv.appendChild(imgContainer);
          }
        }
      }

      function OnLoad() {
      
        // Create an Image Search instance.
        imageSearch = new google.search.ImageSearch();

        // Set searchComplete as the callback function when a search is 
        // complete.  The imageSearch object will have results in it.
        imageSearch.setSearchCompleteCallback(this, searchComplete, null);

        // Find me a beautiful car.
        imageSearch.execute("Subaru STI");
        
        // Include the required Google branding
        google.search.Search.getBranding('branding');
      }
      google.setOnLoadCallback(OnLoad);*/
    </script>

  </head>
  <body style="font-family: Arial;border: 0 none;">
    <div id="branding"  style="float: left;"></div><br />
    <img id="content" src=""/>
  </body>
</html>